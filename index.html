<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>点击圆圈验证码示例</title>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "PingFang SC",
        "Microsoft YaHei", sans-serif;
      background: #0f172a;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #e5e7eb;
    }

    .page {
      width: 100%;
      max-width: 520px;
      padding: 16px;
    }

    .card {
      background: radial-gradient(circle at top left, #1e293b, #020617);
      border-radius: 18px;
      padding: 20px 22px 24px;
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.8);
      border: 1px solid rgba(148, 163, 184, 0.25);
    }

    .card-header {
      margin-bottom: 16px;
    }

    .card-title {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .card-title-badge {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid rgba(96, 165, 250, 0.7);
      color: #93c5fd;
    }

    .card-subtitle {
      font-size: 13px;
      color: #9ca3af;
    }

    .captcha-box {
      margin-top: 16px;
      padding: 12px 12px 14px;
      border-radius: 14px;
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid rgba(55, 65, 81, 0.9);
    }

    .captcha-title {
      font-size: 14px;
      margin-bottom: 4px;
    }

    .captcha-desc {
      font-size: 12px;
      color: #9ca3af;
      margin-bottom: 8px;
    }

    .circle-area {
      position: relative;
      margin-top: 8px;
      margin-bottom: 10px;
      height: 180px;
      border-radius: 12px;
      background: radial-gradient(circle at top, #111827, #020617);
      overflow: hidden;
    }

    .circle {
      position: absolute;
      width: 80px;
      height: 80px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #fef3c7, #f97316);
      box-shadow:
        0 0 25px rgba(249, 115, 22, 0.7),
        0 0 60px rgba(251, 146, 60, 0.5);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #111827;
      font-weight: 700;
      font-size: 14px;
      user-select: none;
      transition: transform 0.08s ease, box-shadow 0.08s ease,
        background 0.1s ease;
    }

    .circle:hover {
      transform: scale(1.06);
      box-shadow:
        0 0 30px rgba(249, 115, 22, 0.8),
        0 0 70px rgba(251, 146, 60, 0.7);
    }

    .circle:active {
      transform: scale(0.98);
      box-shadow:
        0 0 18px rgba(249, 115, 22, 0.6),
        0 0 40px rgba(251, 146, 60, 0.5);
    }

    .circle--second {
      background: radial-gradient(circle at 30% 20%, #e0f2fe, #3b82f6);
      box-shadow:
        0 0 25px rgba(59, 130, 246, 0.7),
        0 0 60px rgba(96, 165, 250, 0.6);
    }

    .captcha-status {
      font-size: 12px;
      min-height: 1.4em;
      color: #9ca3af;
    }

    .captcha-status.ok {
      color: #4ade80;
    }

    .captcha-status.error {
      color: #f97373;
    }

    .captcha-status.bot {
      color: #f97316;
    }

    .captcha-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 8px;
      font-size: 12px;
      color: #6b7280;
    }

    .captcha-info {
      opacity: 0.9;
    }

    .captcha-btn-refresh {
      border-radius: 999px;
      border: 1px solid rgba(75, 85, 99, 0.9);
      background: rgba(15, 23, 42, 0.9);
      color: #e5e7eb;
      padding: 4px 10px;
      font-size: 12px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition: background 0.08s ease, border-color 0.08s ease,
        transform 0.08s ease;
    }

    .captcha-btn-refresh:hover {
      background: rgba(31, 41, 55, 0.95);
      border-color: rgba(148, 163, 184, 0.9);
      transform: translateY(-0.5px);
    }

    .captcha-btn-refresh:active {
      transform: translateY(0);
    }

    .hint {
      margin-top: 14px;
      font-size: 11px;
      color: #64748b;
      line-height: 1.5;
    }

    .hint code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
        "Liberation Mono", "Courier New", monospace;
      font-size: 11px;
      background: rgba(15, 23, 42, 0.9);
      padding: 2px 5px;
      border-radius: 4px;
      border: 1px solid rgba(51, 65, 85, 0.9);
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="card">
      <div class="card-header">
        <div class="card-title">
          点击圆圈验证码
          <span class="card-title-badge">行为验证 · Demo</span>
        </div>
        <div class="card-subtitle">
          两次点击圆圈
        </div>
      </div>

      <div class="captcha-box" id="circle-captcha" data-valid="0">
        <div class="captcha-title">验证规则：</div>
        <div class="captcha-desc">
          第一步：点击第一个圆圈。<br />
          第二步：等待二个圆圈出现，再次点击。<br />
          
        </div>

        <div class="circle-area" id="circle-area">
          <!-- 圆圈通过 JS 动态创建 -->
        </div>

        <div id="captcha-status" class="captcha-status">
          请先点击第一个圆圈开始验证。
        </div>

        <div class="captcha-footer">
          <div class="captcha-info" id="captcha-info">
            等待操作…
          </div>
          <button type="button" id="captcha-refresh" class="captcha-btn-refresh">
            重置验证
          </button>
        </div>
      </div>

      <div class="hint">
        你可以在表单提交前检测：
        <code>dataset.valid === "1"</code> 来判断是否通过验证。
      </div>
    </div>
  </div>

  <script>
    (function () {
      const container = document.getElementById("circle-captcha");
      const area = document.getElementById("circle-area");
      const statusEl = document.getElementById("captcha-status");
      const infoEl = document.getElementById("captcha-info");
      const refreshBtn = document.getElementById("captcha-refresh");

      if (!container || !area) return;

      const STATE = {
        step: 0, // 0: 等待第一次点击, 1: 等待第二个圆圈出现, 2: 等待第二次点击, 3: 完成
        firstClickTime: null,
        secondClickTime: null,
        timerId: null,
        delayMs: null
      };

      const CIRCLE_SIZE = 80;
      const MAX_INTERVAL_MS = 6000; // 6 秒判定 bot

      function setStatus(text, type) {
        statusEl.textContent = text || "";
        statusEl.classList.remove("ok", "error", "bot");
        if (type) statusEl.classList.add(type);
      }

      function setInfo(text) {
        infoEl.textContent = text || "";
      }

      function clearArea() {
        while (area.firstChild) {
          area.removeChild(area.firstChild);
        }
      }

      function centerCircle(circle) {
        const rect = area.getBoundingClientRect();
        const x = (rect.width - CIRCLE_SIZE) / 2;
        const y = (rect.height - CIRCLE_SIZE) / 2;
        circle.style.left = x + "px";
        circle.style.top = y + "px";
      }

      function randomCirclePosition(circle) {
        const rect = area.getBoundingClientRect();
        const padding = 10;
        const maxX = Math.max(padding, rect.width - CIRCLE_SIZE - padding);
        const maxY = Math.max(padding, rect.height - CIRCLE_SIZE - padding);

        const x = padding + Math.random() * (maxX - padding);
        const y = padding + Math.random() * (maxY - padding);

        circle.style.left = x + "px";
        circle.style.top = y + "px";
      }

      function createFirstCircle() {
        clearArea();
        const circle = document.createElement("div");
        circle.className = "circle circle--first";
        circle.textContent = "1";

        centerCircle(circle);

        circle.addEventListener("click", function () {
          if (STATE.step !== 0) return;

          STATE.firstClickTime = performance.now();
          STATE.step = 1;
          container.dataset.valid = "0";

          setStatus("第一步已完成，正在准备第二个圆圈…", "ok");

          // 1–2 秒随机延迟
          const delay = 1000 + Math.random() * 1000;
          STATE.delayMs = delay;
          setInfo("等待第二个圆圈出现");

          // 禁用第一个圆圈点击
          circle.style.pointerEvents = "none";
          circle.style.opacity = "0.6";

          STATE.timerId = setTimeout(function () {
            STATE.step = 2;
            createSecondCircle();
            setStatus("第二个圆圈已出现，请尽快点击完成验证。", null);
            setInfo(
              ""
            );
          }, delay);
        });

        area.appendChild(circle);
      }

      function createSecondCircle() {
        clearArea();

        const circle = document.createElement("div");
        circle.className = "circle circle--second";
        circle.textContent = "2";

        // 第二个圆圈位置随机
        randomCirclePosition(circle);

        circle.addEventListener("click", function () {
          if (STATE.step !== 2) return;
          STATE.secondClickTime = performance.now();
          STATE.step = 3;

          const diffMs = STATE.secondClickTime - STATE.firstClickTime;
          const diffSec = (diffMs / 1000).toFixed(2);

          if (diffMs > MAX_INTERVAL_MS) {
            // 判定为 bot
            setStatus(
              "用时 " +
                diffSec +
                " 秒，超过 6 秒，疑似 bot，验证失败并已重置。",
              "bot"
            );
            container.dataset.valid = "0";
            setInfo("");

            // 1 秒后重置
            setTimeout(function () {
              resetCaptcha();
            }, 1000);
          } else {
            // 判定为人类
            setStatus(
              "用时 " +
                diffSec +
                " 秒，验证通过，当前会话认为是人类用户。",
              "ok"
            );
            container.dataset.valid = "1";
            setInfo("你可以在表单提交逻辑中检查 data-valid=1 来确认通过。");

            // 锁定圆圈
            circle.style.pointerEvents = "none";
          }
        });

        area.appendChild(circle);
      }

      function resetCaptcha() {
        // 清除状态
        if (STATE.timerId) {
          clearTimeout(STATE.timerId);
          STATE.timerId = null;
        }
        STATE.step = 0;
        STATE.firstClickTime = null;
        STATE.secondClickTime = null;
        STATE.delayMs = null;
        container.dataset.valid = "0";

        setStatus("请点击第一个圆圈开始验证。", null);
        setInfo("等待操作…");

        createFirstCircle();
      }

      refreshBtn.addEventListener("click", function () {
        resetCaptcha();
      });

      // 初始化
      resetCaptcha();

      // 如果窗口大小变化，简单做一个重新布局（不强制）
      window.addEventListener("resize", function () {
        // 只有在第一步或第二步进行中时才重布居
        if (STATE.step === 0 || STATE.step === 2) {
          const circle = area.querySelector(".circle");
          if (circle) {
            if (STATE.step === 0) {
              centerCircle(circle);
            } else if (STATE.step === 2) {
              randomCirclePosition(circle);
            }
          }
        }
      });
    })();
  </script>
</body>
</html>
